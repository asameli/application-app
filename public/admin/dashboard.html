<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles.css">
</head>
<body class="admin-body">
  <header class="header-bar">
    <div class="logo">surwave</div>
    <h1 class="fancy-title">Admin Dashboard</h1>
  </header>
  <div class="container fancy-card">
    <p class="total-apps">Total Applications: <span id="appCount">0</span></p>
    <table class="apps-table" id="applicationsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Name</th>
          <th>Email</th>
          <th>Status</th>
          <th>Submitted At</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- Applications will be dynamically inserted here -->
      </tbody>
    </table>
    <div id="emptyMessage" class="empty-message" style="display:none;">No applications found.</div>

    <h2 class="section-title">Email Templates</h2>
    <form id="templatesForm">
      <label for="thankYou">Thank You Template:</label>
      <textarea name="thankYou" id="thankYou" rows="4"></textarea>

      <label for="accepted">Accepted Template:</label>
      <textarea name="accepted" id="accepted" rows="4"></textarea>

      <label for="rejected">Rejected Template:</label>
      <textarea name="rejected" id="rejected" rows="4"></textarea>

      <button type="submit">Update Templates</button>
    </form>
    <a class="logout-link" href="/admin/logout">Logout</a>
  </div>
  <script>
    // Fetch and display applications
    function fetchApplications() {
      fetch('/admin/api/applications')
        .then(response => response.json())
        .then(data => {
          const tableBody = document.querySelector('#applicationsTable tbody');
          const emptyMessage = document.getElementById('emptyMessage');
          tableBody.innerHTML = '';
          if (data.length === 0) {
            emptyMessage.style.display = 'block';
          } else {
            emptyMessage.style.display = 'none';
            data.forEach(app => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${app.id}</td>
                <td>${app.firstname} ${app.lastname}</td>
                <td>${app.email}</td>
                <td>${app.status}</td>
                <td>${app.created_at}</td>
                <td class="actions-cell">
                  <button class="status-btn accept-btn" onclick="updateStatus('${app.id}', 'accepted')">Accept</button>
                  <button class="status-btn reject-btn" onclick="updateStatus('${app.id}', 'rejected')">Reject</button>
                  <button class="delete-btn" onclick="deleteApplication('${app.id}')">Delete</button>
                </td>
              `;
              tableBody.appendChild(row);
            });
          }
        });
    }

    // Fetch application count
    function fetchCount() {
      fetch('/admin/api/count')
        .then(response => response.json())
        .then(data => {
          document.getElementById('appCount').innerText = data.count;
        });
    }

    // Fetch email templates
    function fetchTemplates() {
      fetch('/admin/api/templates')
        .then(response => response.json())
        .then(data => {
          document.getElementById('thankYou').value = data.thankYou;
          document.getElementById('accepted').value = data.accepted;
          document.getElementById('rejected').value = data.rejected;
        });
    }

    // Update application status
    function updateStatus(id, status) {
      fetch(`/admin/api/application/${id}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      })
      .then(response => response.json())
      .then(data => {
        alert(data.message);
        fetchApplications();
        fetchCount();
      });
    }

    // Delete application
    function deleteApplication(id) {
      if (!confirm('Are you sure you want to delete this application?')) {
        return;
      }
      fetch(`/admin/api/application/${id}`, {
        method: 'DELETE'
      })
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          alert(data.message);
        }
        fetchApplications();
        fetchCount();
      });
    }

    // Handle email template updates
    document.getElementById('templatesForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const templates = {
        thankYou: document.getElementById('thankYou').value,
        accepted: document.getElementById('accepted').value,
        rejected: document.getElementById('rejected').value
      };
      fetch('/admin/api/templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(templates)
      })
      .then(response => response.json())
      .then(data => alert(data.message));
    });

    // Initial fetches
    fetchApplications();
    fetchCount();
    fetchTemplates();
  </script>
</body>
</html>
